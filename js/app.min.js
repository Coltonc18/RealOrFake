var overviewAvgResult = ((overviewObject.total.answersCompleted.correct || 0) / overviewParticipants).toFixed(0);
var overviewImagePercentage = ((overviewObject.perContentType.image.correct || 0) / overviewObject.perContentType.image.answers || 0 * 100).toFixed(0);
var overviewTextPercentage = ((overviewObject.perContentType.text.correct || 0) / overviewObject.perContentType.text.answers || 0 * 100).toFixed(0);

var resultTemplate = $("template#resultItem").html();

$('span[data="correct"').text(resultTotalCorrect);
$('span[data="answered"').text("/" + resultTotalAnswered);
$('span[data="participants"').text(overviewParticipants);
$('span[data="avgResult"').text(overviewAvgResult + "/" + resultTotalAnswered);
$('span[data="imagePercentage"').text(overviewImagePercentage);
$('span[data="textPercentage"').text(overviewTextPercentage);

$.map(resultObject, function (object) {
    questionIndex++;

    if ("id" in object) {
        var objectId = object.id;
        var objectIdInt = parseInt(objectId);
        var contentId = object.contentId;
        var contentType = object.contentType;
        var result = object.result;
        var validity = object.validity;

        var contentElement = $("#" + contentId);

        var src = contentElement.attr("src");

        var titleSpan = $(contentElement).find(".text-title > span");
        var contentSpan = $(contentElement).find(".text-content > p");

        var title = titleSpan.text();
        var content = contentSpan.text();

        var answers = overviewObject.perContent[contentType + "_" + contentId].answers;
        var correctPercentage = ((overviewObject.perContent[contentType + "_" + contentId].correct || 0) / answers * 100).toFixed(0);

        var resultItem = $(resultTemplate);

        resultItem.addClass(contentType);

        if (contentType === "text") {
            resultItem.find('div[data="contentTypeImage"]').css("display", "none");
            resultItem.find('div[data="contentTypeText"] > .text-title > span').text(title);
            resultItem.find('div[data="contentTypeText"] > .text-content > p').text(content);
            var author = "Written by " + validity;
        } else if (contentType === "image") {
            resultItem.find('div[data="contentTypeText"]').css("display", "none");
            resultItem.find('img[data="contentImage"]').attr("src", src);

            if (validity === "Humans") {
                var author = "A real Human";
            } else if (validity === "AI") {
                var author = "Generated by " + validity;
            }
        }

        if (validity === "Humans") {
            resultItem.find('div[data="validity"] img[value="ai"]').css("display", "none");
            resultItem.find('div[data="validity"] > span').text(author);

            if (result === "correct") {
                resultItem.find('div[data="guess"] > span').text("You guessed Human");
            } else if (result === "wrong") {
                resultItem.find('div[data="guess"] > span').text("You guessed AI");
            }
        } else if (validity === "AI") {
            resultItem.find('div[data="validity"] img[value="human"]').css("display", "none");
            resultItem.find('div[data="validity"] > span').text(author);

            if (result === "correct") {
                resultItem.find('div[data="guess"] > span').text("You guessed AI");
            } else if (result === "wrong") {
                resultItem.find('div[data="guess"] > span').text("You guessed Human");
            }
        }

        resultItem.find('div[data="result"]').addClass(result);

        for (var i = 0; i < src[n].href.length; i++) {
            var sourceDiv = resultItem.find('div[data="source"]');
            if (i > 0) {
                $("<span/>", {
                    text: " + "
                }).appendTo(sourceDiv);
            }
            $("<a/>", {
                target: "_blank",
                href: src[n].href[i],
                text: src[n].text[i]
            }).appendTo(sourceDiv);
        }

        resultItem.find('div[data="percentage"] > span').text(correctPercentage + "% of people guessed correctly from a total of " + answers + " answers");

        if (result === "correct") {
            resultItem.find('div[data="result"] > svg[value="wrong"]').css("display", "none");
        } else if (result === "wrong") {
            resultItem.find('div[data="result"] > svg[value="correct"]').css("display", "none");
        }

        resultItem.find('span[data="questionNumber"]').text("Question " + questionIndex);

        $(".result.breakdown").append(resultItem);
    }
});

function randomizeContent(page) {
    var randomItems = $("#page" + page + " .random");

    for (var i = 0; i < randomItems.length; i++) {
        var target = Math.floor(Math.random() * randomItems.length - 1) + 1;
        var target2 = Math.floor(Math.random() * randomItems.length - 1) + 1;
        randomItems.eq(target).before(randomItems.eq(target2));
    }

    var chosen = $("#page" + page + " .randomize > *:nth-child(2)");
    chosen.addClass("chosen");
    chosen.attr("src", chosen.attr("data-src"));

    for (var i = 0; i < randomItems.length; i++) {
        if (!$(randomItems[i]).hasClass("chosen")) {
            $(randomItems[i]).remove();
        }
    }
}

function randomizePage() {
    var questionPages = $('.page[value="question"]');
    var index = 2;

    for (var i = 0; i < questionPages.length; i++) {
        var target = Math.floor(Math.random() * questionPages.length - 1) + 1;
        var target2 = Math.floor(Math.random() * questionPages.length - 1) + 1;
        questionPages.eq(target).before(questionPages.eq(target2));
    }

    questionPages.each(function () {
        $(this).attr("id", "page" + index);
        index++;
    });
}

function collectAndSendInputs(page, button) {
    var buttonElement = $(button);

    $("#page" + (page - 1) + " .question").each(function () {
        var questionElement = $(this);
        var chosenOption = $(".chosen[question=" + questionElement.attr("id") + "]");
        var questionId = questionElement.attr("id");
        var chosenId = chosenOption.attr("id");
        var questionType = questionElement.attr("type");
        var result = "no answer";

        var resultObject = {};

        var resultIndex = page - 1;
        var resultIndexMinus2 = resultIndex - 2;

        $("input", questionElement).each(function () {
            var inputElement = $(this);
            result["results/question_" + resultIndexMinus2 + "_" + questionId + "/" + inputElement.attr("value")] = "false";

            if (buttonElement) {
                result["results/question_" + resultIndexMinus2 + "_" + questionId + "/" + inputElement.attr("value")] = "true";
                result = (buttonElement.attr("value") === "selectsAI" && chosenId % 2 === 0) ? "correct" : (buttonElement.attr("value") === "selectsHuman" && Math.abs(chosenId % 2) === 1) ? "correct" : "wrong";
            }
        });

        var perQuestionPath = "perQuestion/question_" + questionId;
        var perContentPath = "perContent/" + questionType + "_" + chosenId;
        var perContentTypePath = "perContentType/" + questionType;

        resultObject.id = id;
        resultObject.startTime = startTime;
        resultObject.completeTime = (new Date()).toUTCString();
        resultObject["results/question_" + resultIndexMinus2 + "_" + questionId + "/id"] = questionId;
        resultObject["results/question_" + resultIndexMinus2 + "_" + questionId + "/contentId"] = chosenId;
        resultObject["results/question_" + resultIndexMinus2 + "_" + questionId + "/contentType"] = questionType;
        resultObject["results/question_" + resultIndexMinus2 + "_" + questionId + "/validity"] = result;
        resultObject["results/question_" + resultIndexMinus2 + "_" + questionId + "/result"] = result;

        updateEntries(resultObject);
    });
}

function start() {
    initQuiz();
}
